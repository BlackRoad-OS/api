# =============================================================================
# Kanban State Synchronization Workflow
# =============================================================================
# Keeps state synchronized across GitHub Projects, Cloudflare KV, and Salesforce
# Runs on:
# - Push to main
# - PR events (opened, closed, merged)
# - Issue events
# - Project card events
# - Manual trigger
# =============================================================================

name: Kanban Sync

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, closed, synchronize, labeled]
  issues:
    types: [opened, closed, labeled, assigned]
  project_card:
    types: [created, moved, deleted]
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force full sync from primary source'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'

jobs:
  sync-state:
    name: Sync Kanban State
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pyyaml requests

      - name: Sync state
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_KV_NAMESPACE_ID: ${{ secrets.CLOUDFLARE_KV_NAMESPACE_ID }}
          SF_CLIENT_ID: ${{ secrets.SF_CLIENT_ID }}
          SF_CLIENT_SECRET: ${{ secrets.SF_CLIENT_SECRET }}
          SF_USERNAME: ${{ secrets.SF_USERNAME }}
          SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
          SF_SECURITY_TOKEN: ${{ secrets.SF_SECURITY_TOKEN }}
        run: |
          python state/sync.py sync

      - name: Check for conflicts
        run: |
          python state/sync.py conflicts

      - name: Report status
        if: always()
        run: |
          echo "Sync completed at $(date)"
          python state/sync.py status

  verify-hashes:
    name: Verify Content Hashes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Verify all hashes
        run: |
          python -c "
          from hashing import sha256
          import yaml
          from pathlib import Path

          errors = []
          for task_file in Path('agents/todos').glob('*.yaml'):
              if task_file.name == 'example-task.yaml':
                  continue
              with open(task_file) as f:
                  task = yaml.safe_load(f)
              if task:
                  stored_hash = task.pop('hash', '')
                  computed = sha256(yaml.dump(task, sort_keys=True))
                  if stored_hash and stored_hash != computed:
                      errors.append(f'{task_file.name}: hash mismatch')

          if errors:
              print('Hash verification failed:')
              for e in errors:
                  print(f'  - {e}')
              exit(1)
          print('All hashes verified!')
          "
